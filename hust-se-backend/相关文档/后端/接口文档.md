# 接口文档


## 一、基础说明
- 所有接口返回格式统一为JSON，包含以下字段：
  - `code`：状态码（200=成功，400=参数错误，403=权限不足，404=资源不存在，500=服务器错误）
  - `msg`：提示信息（成功/错误描述）
  - `data`：业务数据（成功时返回，具体结构见各接口）
- 需登录的接口会验证用户身份（通过session），未登录时会返回401错误
- 时间格式统一为：`YYYY-MM-DD HH:MM` 或 `YYYY-MM-DD HH:MM:SS`


## 二、用户相关接口（前缀：`/user`）

### 1. 用户注册
- **接口路径**：`/user/register`
- **请求方法**：`POST`
- **权限要求**：公开（无需登录）
- **请求体参数**：
  | 参数名   | 类型   | 是否必填 | 说明                 |
  |----------|--------|----------|----------------------|
  | phone    | string | 是       | 手机号（11位，唯一） |
  | password | string | 是       | 密码（需加密存储）   |
  | username | string | 是       | 用户名（唯一）       |
  | identity | string | 否       | 用户身份（默认buyer）|
  | major    | string | 否       | 专业                 |
  | grade    | string | 否       | 年级                 |
- **返回示例**：
```json
{
  "code": 200,
  "msg": "注册成功",
  "data": {
    "id": 1,
    "phone": "13800138000",
    "username": "张三",
    "credit": 100
  }
}
```
- **错误示例**：
  - 缺少参数：`{"code":400,"msg":"缺少必填的参数，请检查（手机号/密码/用户名）"}`
  - 手机号已注册：`{"code":400,"msg":"手机号已被注册"}`


### 2. 用户登录
- **接口路径**：`/user/login`
- **请求方法**：`POST`
- **权限要求**：公开（无需登录）
- **请求体参数**：
  | 参数名   | 类型   | 是否必填 | 说明       |
  |----------|--------|----------|------------|
  | phone    | string | 是       | 手机号     |
  | password | string | 是       | 密码       |
- **返回示例**：
```json
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "user": {
      "id": 1,
      "username": "张三",
      "phone": "13800138000"
    }
  }
}
```
- **错误示例**：
  - 账号密码错误：`{"code":400,"msg":"手机号或密码错误"}`


## 三、书籍相关接口（前缀：`/book`）

### 1. 发布书籍（卖家）
- **接口路径**：`/book/create`
- **请求方法**：`POST`
- **权限要求**：需登录（发布者为当前登录用户）
- **请求体参数**：
  | 参数名       | 类型   | 是否必填 | 说明                          |
  |--------------|--------|----------|-------------------------------|
  | title        | string | 是       | 书名                          |
  | course_tag   | string | 是       | 课程标签（如“高等数学”）      |
  | condition    | string | 是       | 新旧程度（1-5，1=全新，5=较旧）|
  | price        | float  | 是       | 售价                          |
  | author       | string | 否       | 作者（默认空）                |
  | description  | string | 否       | 书籍描述（默认空）            |
  | images       | string | 否       | 图片URL（多个用逗号分隔，默认空）|
- **返回示例**：
```json
{
  "code": 200,
  "msg": "书籍发布成功",
  "data": {
    "id": 1,
    "title": "高等数学（第七版）",
    "author": "同济大学数学系",
    "course_tag": "高等数学",
    "condition": "2",
    "price": 20.0,
    "seller_id": 1,
    "status": 1,
    "status_text": "在售",
    "create_time": "2024-05-20 15:30:00"
  }
}
```
- **错误示例**：
  - 缺少参数：`{"code":400,"msg":"缺少必要参数title"}`


### 2. 多条件检索书籍
- **接口路径**：`/book/list`
- **请求方法**：`GET`
- **权限要求**：公开（无需登录）
- **查询参数**：
  | 参数名      | 类型   | 是否必填 | 说明                          |
  |-------------|--------|----------|-------------------------------|
  | course_tag  | string | 否       | 按课程标签筛选（如“高等数学”）|
  | major_tag   | string | 否       | 按专业标签筛选                |
  | grade_tag   | string | 否       | 按年级标签筛选                |
  | min_price   | float  | 否       | 最低价格                      |
  | max_price   | float  | 否       | 最高价格                      |
  | sort_by     | string | 否       | 排序字段（price/默认create_time）|
  | order       | string | 否       | 排序方式（asc=升序/desc=降序，默认desc）|
  | page        | int    | 否       | 页码（默认1）                 |
  | per_page    | int    | 否       | 每页条数（默认10）            |
- **返回示例**：
```json
{
  "code": 200,
  "data": {
    "books": [
      {
        "id": 1,
        "title": "高等数学（第七版）",
        "author": "同济大学数学系",
        "course_tag": "高等数学",
        "condition": "2",
        "price": 20.0,
        "seller_id": 1,
        "status_text": "在售",
        "create_time": "2024-05-20 15:30:00"
      }
    ],
    "total": 1,
    "page": 1,
    "per_page": 10,
    "pages": 1
  }
}
```


### 3. 查询书籍详情
- **接口路径**：`/book/<int:book_id>`
- **请求方法**：`GET`
- **权限要求**：公开（无需登录）
- **路径参数**：
  | 参数名   | 类型 | 说明       |
  |----------|------|------------|
  | book_id  | int  | 书籍ID     |
- **返回示例**：
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "title": "高等数学（第七版）",
    "author": "同济大学数学系",
    "course_tag": "高等数学",
    "condition": "2",
    "price": 20.0,
    "seller_id": 1,
    "description": "轻微笔记，不影响阅读",
    "images": "url1,url2",
    "status_text": "在售",
    "create_time": "2024-05-20 15:30:00"
  }
}
```
- **错误示例**：
  - 书籍不存在/已售出：`{"code":404,"msg":"书籍不存在 or 已售出~"}`


## 四、订单相关接口（前缀：`/order`）

### 1. 创建订单（买家）
- **接口路径**：`/order/create`
- **请求方法**：`POST`
- **权限要求**：需登录（买家为当前登录用户）
- **请求体参数**：
  | 参数名   | 类型 | 是否必填 | 说明       |
  |----------|------|----------|------------|
  | book_id  | int  | 是       | 书籍ID     |
- **业务约束**：
  - 不能购买自己发布的书籍
  - 书籍必须处于“在售”状态（status=1）
- **返回示例**：
```json
{
  "code": 200,
  "msg": "订单创建成功",
  "data": {
    "id": 1,
    "order_no": "171620000011234",
    "buyer_id": 2,
    "buyer_name": "李四",
    "seller_id": 1,
    "seller_name": "张三",
    "book_id": 1,
    "book_title": "高等数学（第七版）",
    "price": 20.0,
    "status": 1,
    "status_text": "待支付",
    "create_time": "2024-05-20 16:00:00"
  }
}
```
- **错误示例**：
  - 书籍已售出：`{"code":404,"msg":"书籍不存在或已售出"}`
  - 购买自己的书：`{"code":400,"msg":"想买自己的书？驳回！"}`


### 2. 查询个人订单列表
- **接口路径**：`/order/list`
- **请求方法**：`GET`
- **权限要求**：需登录
- **查询参数**：
  | 参数名 | 类型   | 是否必填 | 说明                          |
  |--------|--------|----------|-------------------------------|
  | role   | string | 否       | 视角（buyer=买家/seller=卖家，默认buyer）|
- **返回示例**：
```json
{
  "code": 200,
  "data": {
    "orders": [
      {
        "id": 1,
        "order_no": "171620000011234",
        "buyer_id": 2,
        "buyer_name": "李四",
        "seller_id": 1,
        "seller_name": "张三",
        "book_id": 1,
        "book_title": "高等数学（第七版）",
        "price": 20.0,
        "status": 1,
        "status_text": "待支付",
        "create_time": "2024-05-20 16:00:00"
      }
    ],
    "total": 1
  }
}
```


### 3. 更新订单状态
- **接口路径**：`/order/<int:order_id>/update`
- **请求方法**：`POST`
- **权限要求**：需登录（按状态验证权限）
- **路径参数**：
  | 参数名    | 类型 | 说明       |
  |-----------|------|------------|
  | order_id  | int  | 订单ID     |
- **请求体参数**：
  | 参数名 | 类型 | 是否必填 | 说明                 |
  |--------|------|----------|----------------------|
  | status | int  | 是       | 新状态（1-5，见下方说明）|
- **订单状态说明**：
  | 状态码 | 状态文本 | 可操作角色       | 前置状态 |
  |--------|----------|------------------|----------|
  | 1      | 待支付   | -                | -        |
  | 2      | 已支付   | 买家             | 1        |
  | 3      | 已发货   | 卖家             | 2        |
  | 4      | 已收货   | 买家             | 3        |
  | 5      | 已完成   | 买家/卖家        | 4        |
- **返回示例**：
```json
{
  "code": 200,
  "msg": "订单状态更新成功",
  "data": {
    "id": 1,
    "order_no": "171620000011234",
    "status": 2,
    "status_text": "已支付",
    // 其他订单字段...
  }
}
```
- **错误示例**：
  - 权限不足：`{"code":403,"msg":"无权限操作此订单"}`
  - 状态跳级（如1→3）：`{"code":400,"msg":"不支持从待支付转为已发货"}`


## 五、补充说明
- 订单号`order_no`为唯一标识，可用于查询订单
- 书籍状态`status`：1=在售，0=已售出（对应`status_text`：“在售”/“已售”）
- 所有创建/更新操作失败时会自动回滚数据库，无需前端处理回滚逻辑